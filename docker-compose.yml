version: "3.8"
name: valytics
services:
  ###
  # Service Containers
  ###
  riot-ingest:
    build:
      context: ./
      dockerfile: ./services/riot-ingest/Dockerfile
    env_file:
      - .env
    volumes:
      - ./services/riot-ingest/src/main:/service
      - ./protobufs:/protobufs
    command: watchmedo auto-restart --recursive --pattern="*.py" --directory="/service/" python3 /service/service.py
    profiles:
      - backend
    ports:
      - 127.0.0.1:${RIOT_INGEST_SERVICE_PORT}:${RIOT_INGEST_SERVICE_PORT}
    networks:
      - valyticsmesh

  ###
  # Test Containers
  ###
  integration:
    build:
      context: ./
      dockerfile: ./builder/integration-test/Dockerfile
    env_file:
      - .env
    volumes:
      - ./services/riot-ingest/src/test:/tests/riot-ingest
      - ./protobufs:/protobufs
    command: pytest /tests
    profiles:
      - test
    networks:
      - valyticsmesh

  python-lint:
    build:
      context: ./
      dockerfile: ./builder/python-lint/Dockerfile
    volumes:
    - ./services:/services
    command: 
      - /bin/bash
      - -c
      - |
        black --version
        black --line-length 120 /services
        flake8 --version
        flake8 /services
    profiles: [ "pre-commit", "pylint" ]
    network_mode: none

networks:
  valyticsmesh:
    driver: bridge
    name: valyticsmesh